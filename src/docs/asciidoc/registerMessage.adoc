= edutech-auth-service

== Getting started

Для работы с plant uml выполните команду:

[source]
----
  git config --local core.hooksPath .git-hooks/
  chmod +x .git-hooks/*
----

Для простого локального запуска продуктового кейклока через [docker compose](distribution/docker-compose):

Переименовать [env_example](distribution/docker-compose/env_example) в .env с указанием вашего именем продукта
или задать переменную окружения PRODUCT_NAME.

После чего можно запустить командой

[source,sh]
----
  cd ../distribution/docker-compose
  docker compose up -d
----


==  1. Назначение сервиса
=== 1.1 Назначение
Сервис предназначен для базовой реализации аутентификации и регистрации пользователей
продуктов экосистемы Сберобразования путем развертывания сервиса в среде продукта.

Сервис должен обеспечивать следующую функциональность при обращении через Gravitee:
1. Предоставить метод для формы аутентификации пользователя с фронта по номеру телефона (логину).<br/><br/>Кастомный флоу аутентификации должен обеспечивать:
3. в случае существования пользователя с таким номером телефона в качестве логина генерацию и отправку через СМС OTP-кода подтверждения аутентификации.
4. в случае отсутствия пользователя с таким номером телефона в качестве логина генерацию и отправку через СМС OTP-кода подтверждения регистрации пользователя. <br/><br/>
3. Предоставить валидацию OTP-кода для формы аутентификации через token в рамках текущей сессии аутентификации.
4. Если пользователь ранее не существовал, после успешной проверки кода OTP пользователь должен быть добавлен в User service, если успешно, то и в KC Auth, после чего аутентифицирован, JWT передан на фронт.
5. Если пользователь ранее существовал, после успешной проверки кода OTP пользователь должен быть аутентифицирован, JWT передан на фронт.<br/><br/>
4. Предоставить в качестве параметров для фронта (доступ анонима): длину OTP-кода и время жизни OTP-кода в секундах

=== 1.2 Состав сервиса
Сервис представляет собой пакет, содержащий кастомную конфигурацию Keycloack SE,
которая включает кастомный флоу регистрации пользователя.

![plot](docs/component.png)


=== 2. Макеты
https://www.figma.com/file/wEeIatcsBDoeRsVuQbh2Cq/Core-1?type=design&node-id=1116-22309&mode=design&t=sJxgv7ttNImx91JD-0

=== 3. Описание пермишенов
Обращаться в API KC из сервисов бэка напрямую, минуя KC Adapter, запрещено. Для обращения с формы аутентификации
необходимо настроить Direct grant flow.

| <b>Вид пользователя KC</b> | <b>Описание</b>                                         |
|----------------------------|---------------------------------------------------------|
| Пользователь KC            | Пользователь, логин которого **есть** в списке Users KC |
| Неизвестный пользователь   | Пользователь, логина которого **нет** в списке Users KC |

== 4. Архитектура сервиса
=== 4.1 Общее описание архитектуры
==== 4.1.1. Архитектурная схема
![plot](docs/architecture.png)

==== 4.1.2. Изображение схемы компонент сервиса (в т.ч. БД, само приложение, его модули и т.д.)
![plot](docs/er-diagram.png)

==== 4.1.3 Sequence диаграмма
![plot](docs/sequence.png)

На диаграмме последовательностей отражен процесс взаимодействя с сервисом, предоставляющим реализацию методов:


**Метод аутентификации** может возвращать следующие ответы:
- успешно, фронт может переходить к запросу ОТП-кода
- ошибка СМС-провайдера, фронт предложит пользователю зайти позже

**Метод валидации OTP-кода** может возвращать следующие ответы:
- успешно, передает JWT на фронт, форма аутентификации может закрываться
- ошибка валидации кода, фронт предложит пользователю новую попытку
- ошибка СМС-провайдера, фронт предложит пользователю зайти позже
- ошибка User service, фронт предложит пользователю зайти позже

=== 4.2 API
Пример создания сообщения аудита:
include::{snippets}/ContractVerifierTest_validate_registerMessage()/curl-request.adoc[]

Пример ответа сервиса после вызова:
include::{snippets}/ContractVerifierTest_validate_registerMessage()/http-response.adoc[]

Поля подлежат валидации, и при ошибке будет выведен статус 400:

Запрос:
include::{snippets}/ContractVerifierTest_validate_registerMessage_1()/http-request.adoc[]

Ответ на запрос - 400 статус
include::{snippets}/ContractVerifierTest_validate_registerMessage_1()/http-response.adoc[]

=== 4.3 Модель данных
some text...

=== 5.4 Особенности масштабирования
some text...

=== 5.5 Используемые БД
some text...

=== 5.6 Использование Kafka
some text...

=== 5.8 ФФ
some text...

=== 6 Тестирование
some text...

=== 8 Журналирование
some text...

=== 9 Аудит
some text...

=== 10 Метрики
some text...

=== 11 Администрирование
some text...